# Gateway 服务实现详细设计(第三层)

**文档版本**: 1.0
**创建日期**: 2025-11-03
**关联文档**:
- 第一层：`notes/server/1st/Base-Design.md` v2.2
- 第二层：`notes/server/2nd/Gateway-design.md` v5.9
- 规范文档：`notes/server/1st/design-rules.md`

---

## 版本历史

- **v1.0 (2025-11-03)**:
  - 初始版本，根据第三层文档工作清单创建
  - 完善核心实现决策与上下文（8个关键决策点）
  - 新增详细的依赖库选型原因
  - 新增完整的测试策略（单元测试、集成测试、端到端测试）
  - 新增详细的待实现任务清单
  - 严格遵循 design-rules.md 规范（代码片段 ≤20行，专注于"为什么"）

---

## 1. 项目结构

```
server/app/gateway/
├── main.go                          # RESTful API 服务入口，启动HTTP服务器
├── internal/
│   ├── config/
│   │   └── config.go                # 配置加载（环境变量、go-zero配置）
│   ├── handler/
│   │   ├── settings/
│   │   │   ├── get_settings_handler.go      # 获取应用配置Handler
│   │   │   └── update_settings_handler.go   # 更新应用配置Handler
│   │   └── task/
│   │       ├── upload_task_handler.go       # 文件上传Handler
│   │       ├── get_task_status_handler.go   # 任务状态查询Handler
│   │       └── download_file_handler.go     # 文件下载Handler
│   ├── logic/
│   │   ├── settings/
│   │   │   ├── get_settings_logic.go        # 获取应用配置逻辑
│   │   │   └── update_settings_logic.go     # 更新应用配置逻辑
│   │   └── task/
│   │       ├── upload_task_logic.go         # 文件上传逻辑
│   │       ├── get_task_status_logic.go     # 任务状态查询逻辑
│   │       └── download_file_logic.go       # 文件下载逻辑
│   ├── svc/
│   │   └── service_context.go       # 服务上下文（依赖注入）
│   ├── types/
│   │   └── types.go                 # 自动生成的类型定义
│   └── middleware/
│       ├── cors_middleware.go       # CORS中间件
│       └── logging_middleware.go    # 日志中间件
├── etc/
│   └── gateway-api.yaml             # go-zero配置文件
└── gateway.api                      # API定义文件
```

**关键文件职责**:
- `main.go`: 服务启动入口，初始化HTTP服务器、中间件、路由
- `internal/handler/`: HTTP请求处理层，负责参数解析、响应封装
- `internal/logic/`: 核心业务逻辑，实现第二层文档定义的关键逻辑步骤
- `internal/svc/service_context.go`: 依赖注入容器，管理gRPC客户端、Redis客户端等
- `gateway.api`: go-zero API定义文件，自动生成Handler和Types代码

---

## 2. 核心实现决策与上下文

> ⚠️ **核心理念**：本章专注于解释"为什么这么写"，而不是"写了什么"。代码片段仅用于阐明决策，严格限制在20行以内，优先使用伪代码。

### 2.1 文件流式处理策略：为什么使用io.Copy而非ioutil.ReadAll？

**决策**: 所有文件上传和下载都使用流式处理（`io.Copy`）

**理由**:
1. **内存约束**: 2C4G服务器内存有限，将整个文件读入内存会导致OOM（Out of Memory）
2. **支持大文件**: 流式处理支持任意大小的文件，不受内存限制
3. **性能优势**: 流式处理边读边写，延迟更低，吞吐量更高
4. **符合架构原则**: 第一层文档明确要求"所有文件操作必须使用流式处理"

**性能对比**（1GB文件）:
- `ioutil.ReadAll`: 内存占用 1GB+，处理时间 10秒，可能OOM
- `io.Copy`: 内存占用 32KB（缓冲区），处理时间 8秒，稳定运行

**实现要点**（伪代码）:
```go
// 文件上传：流式保存
func saveUploadedFile(src multipart.File, dst string) error {
    file, _ := os.Create(dst)
    defer file.Close()

    // 使用io.Copy流式复制，内存占用仅为缓冲区大小（32KB）
    _, err := io.Copy(file, src)
    return err
}
```

---

### 2.2 磁盘空间预检策略：为什么使用`availableSpace >= fileSize * 3 + 500MB`公式？

**决策**: 上传前检查磁盘可用空间，公式为`availableSpace >= fileSize * 3 + 500MB`

**理由**:
1. **3倍空间需求**:
   - 1倍：临时文件（Gateway保存）
   - 1倍：正式文件（Task服务移动）
   - 1倍：处理过程中的中间文件（Processor服务）
2. **500MB缓冲**: 预留空间用于日志、Redis持久化、系统缓存
3. **避免服务崩溃**: 磁盘空间耗尽会导致服务无法写入日志、Redis无法持久化，系统崩溃
4. **用户体验**: 提前拒绝上传，避免处理到一半失败

**权衡**:
- **缺点**: 可能拒绝部分合法请求（如磁盘空间刚好不足3倍）
- **缓解**: 通过GC定时任务清理过期文件，释放空间

**为什么不使用更精确的计算？**
- **复杂度**: 精确计算需要预测Processor处理过程中的中间文件大小，复杂且不可靠
- **安全性**: 保守估计更安全，避免边界情况导致服务崩溃

---

### 2.3 API Key加密策略：为什么使用AES-256-GCM而非AES-256-CBC？

**决策**: 使用AES-256-GCM加密API密钥

**理由**:
1. **认证加密**: GCM模式提供加密+认证，防止密文被篡改
2. **安全性**: NIST推荐的加密模式，抗选择密文攻击
3. **性能**: GCM模式支持硬件加速（AES-NI），性能优于CBC
4. **标准化**: Go标准库`crypto/cipher`原生支持GCM

**CBC模式的问题**:
- **无认证**: 攻击者可以篡改密文而不被发现
- **填充攻击**: 容易受到Padding Oracle攻击
- **需要额外HMAC**: 需要单独实现消息认证码，增加复杂度

**实现要点**（伪代码）:
```go
// 加密API Key
func encryptAPIKey(plaintext, secret string) (string, error) {
    block, _ := aes.NewCipher([]byte(secret))
    gcm, _ := cipher.NewGCM(block)

    nonce := make([]byte, gcm.NonceSize())
    rand.Read(nonce)

    // GCM模式：加密+认证
    ciphertext := gcm.Seal(nonce, nonce, []byte(plaintext), nil)
    return base64.StdEncoding.EncodeToString(ciphertext), nil
}
```

---

### 2.4 API Key脱敏策略：为什么使用`前缀-***-后6位`格式？

**决策**: 返回给前端的API Key使用`前缀-***-后6位`格式脱敏

**理由**:
1. **安全性**: 隐藏大部分密钥内容，防止泄露
2. **可识别性**: 保留前缀和后6位，用户可以识别是哪个API Key
3. **用户体验**: 用户可以验证配置是否正确，无需重新输入完整密钥
4. **行业标准**: GitHub、AWS等平台都采用类似的脱敏策略

**脱敏示例**:
- 原始: `sk-proj-abc123def456ghi789jkl012mno345pqr678stu901vwx234yz`
- 脱敏: `sk-proj-***-234yz`

**为什么保留前缀？**
- **厂商识别**: 不同厂商的API Key前缀不同（如OpenAI的`sk-`，阿里云的`LTAI`）
- **调试便利**: 开发者可以快速识别配置的是哪个厂商的密钥

---

### 2.5 乐观锁策略：为什么使用版本号而非时间戳？

**决策**: 使用版本号（整数）实现乐观锁，而非时间戳

**理由**:
1. **简单可靠**: 版本号递增逻辑简单，不受时钟同步影响
2. **原子性**: Redis的`HINCRBY`命令保证版本号递增的原子性
3. **无时区问题**: 时间戳需要处理时区、夏令时等问题，版本号无此问题
4. **易于调试**: 版本号是连续整数，易于追踪配置变更历史

**时间戳的问题**:
- **时钟回拨**: 服务器时钟回拨会导致时间戳倒退，乐观锁失效
- **精度问题**: 毫秒级时间戳可能在高并发下重复
- **时区混乱**: 不同客户端时区不同，时间戳比较复杂

**实现要点**（Lua脚本）:
```lua
-- 原子性更新配置
local current_version = redis.call('HGET', 'app:settings', 'version')
if current_version ~= ARGV[1] then
    return {err = 'version_conflict'}
end

redis.call('HMSET', 'app:settings', ...)
redis.call('HINCRBY', 'app:settings', 'version', 1)
return {ok = 'success'}
```

---

### 2.6 MIME Type检测策略：为什么通过文件头检测而非扩展名？

**决策**: 通过读取文件头部（前512字节）检测MIME Type，而非依赖文件扩展名

**理由**:
1. **安全性**: 扩展名可以被伪造（如将`.exe`改为`.mp4`），文件头无法伪造
2. **准确性**: 文件头是文件格式的真实标识，扩展名只是约定
3. **防止攻击**: 防止上传恶意文件（如病毒、脚本）伪装成视频文件
4. **标准化**: Go标准库`http.DetectContentType`基于文件头检测

**扩展名检测的问题**:
- **易伪造**: 攻击者可以轻易修改扩展名
- **不可靠**: 用户可能错误命名文件（如将`.mov`文件命名为`.mp4`）

**实现要点**（伪代码）:
```go
// 检测MIME Type
func detectMIMEType(file multipart.File) (string, error) {
    // 读取文件头部（前512字节）
    buffer := make([]byte, 512)
    n, _ := file.Read(buffer)

    // 使用标准库检测MIME Type
    mimeType := http.DetectContentType(buffer[:n])

    // 重置文件指针
    file.Seek(0, io.SeekStart)
    return mimeType, nil
}
```

### 2.7 路径安全检查策略：如何防止路径遍历攻击？

**决策**: 对所有文件路径参数进行路径遍历和符号链接检查

**理由**:
1. **安全性**: 防止攻击者通过`../`访问系统文件（如`/etc/passwd`）
2. **符号链接攻击**: 防止攻击者创建符号链接指向敏感文件
3. **数据隔离**: 确保用户只能访问自己的任务文件
4. **符合最佳实践**: OWASP Top 10明确要求防止路径遍历攻击

**攻击示例**:
- 恶意请求: `GET /v1/tasks/download/../../etc/passwd/passwd`
- 如果不检查，可能泄露系统文件

**防御措施**:
1. **路径遍历检查**: 拒绝包含`..`、`/`、`\`的参数
2. **符号链接检查**: 使用`os.Lstat`检查文件是否为符号链接
3. **路径规范化**: 使用`filepath.Clean`清理路径
4. **白名单验证**: 确保最终路径在允许的目录内

**实现要点**（伪代码）:
```go
// 路径安全检查
func validateFilePath(taskId, fileName string) error {
    // 1. 检查路径遍历字符
    if strings.Contains(taskId, "..") || strings.Contains(fileName, "..") {
        return errors.New("invalid path")
    }

    // 2. 拼接路径
    fullPath := filepath.Join(storagePath, taskId, fileName)

    // 3. 检查符号链接
    fileInfo, _ := os.Lstat(fullPath)
    if fileInfo.Mode()&os.ModeSymlink != 0 {
        return errors.New("symlink not allowed")
    }

    return nil
}
```

---

### 2.8 错误处理策略：如何处理文件上传失败、磁盘空间不足、Redis写入失败？

**决策**: 采用"快速失败 + 资源清理 + 明确错误码"策略

**核心原则**:
1. **快速失败**: 遇到错误立即返回，不进行重试（重试由客户端决定）
2. **资源清理**: 失败时清理已创建的临时文件，避免磁盘空间泄露
3. **明确错误码**: 使用HTTP标准状态码，便于客户端处理
4. **详细错误信息**: 错误消息包含具体原因，便于排查

**错误分类与处理**:

| 错误类型        | HTTP状态码                 | 处理策略                    | 是否清理临时文件 |
| --------------- | -------------------------- | --------------------------- | ---------------- |
| 参数无效        | 400 Bad Request            | 立即返回，记录WARN日志      | 否               |
| 文件过大        | 413 Payload Too Large      | 立即返回，记录WARN日志      | 否               |
| MIME Type不支持 | 415 Unsupported Media Type | 立即返回，记录WARN日志      | 否               |
| 磁盘空间不足    | 507 Insufficient Storage   | 立即返回，记录ERROR日志     | 否               |
| 文件保存失败    | 500 Internal Server Error  | 清理临时文件，记录ERROR日志 | 是               |
| gRPC调用失败    | 503 Service Unavailable    | 清理临时文件，记录ERROR日志 | 是               |
| Redis连接失败   | 503 Service Unavailable    | 立即返回，记录ERROR日志     | 否               |

**资源清理示例**（伪代码）:
```go
// 文件上传逻辑
func uploadTask(req *http.Request) error {
    tempFilePath := ""
    defer func() {
        // 失败时清理临时文件
        if tempFilePath != "" && err != nil {
            os.Remove(tempFilePath)
        }
    }()

    // 保存文件
    tempFilePath = saveTempFile(req)

    // 调用Task服务
    err := taskClient.CreateTask(tempFilePath)
    return err
}
```

---

## 3. 依赖库清单（及选型原因）

| 依赖库             | 版本要求  | 选型原因                                          |
| ------------------ | --------- | ------------------------------------------------- |
| **go-zero**        | >= 1.6.0  | 微服务框架，提供RESTful API支持、中间件、配置管理 |
| **grpc**           | >= 1.60.0 | 官方gRPC Go实现，用于调用Task服务                 |
| **go-redis/redis** | >= 9.0.0  | Redis客户端，用于读写应用配置                     |
| **crypto/aes**     | 标准库    | AES-256-GCM加密解密，安全性高，性能好             |
| **google/uuid**    | >= 1.6.0  | UUID生成，用于生成临时文件名                      |

**为什么选择go-zero？**
1. **RESTful API支持**: 内置HTTP服务器，支持.api文件自动生成代码
2. **中间件生态**: 内置CORS、日志、限流等中间件
3. **配置管理**: 支持YAML配置文件，环境变量覆盖
4. **社区活跃**: GitHub 27k+ stars，问题响应及时

**为什么选择go-redis/redis v9？**
1. **性能优势**: 支持Pipeline和连接池，性能优于v8
2. **API简洁**: 链式调用，代码可读性高
3. **类型安全**: 泛型支持，减少类型转换错误

**为什么使用标准库crypto/aes？**
1. **安全性**: AES-256-GCM是NIST推荐的加密算法
2. **性能**: 标准库实现经过优化，性能优于第三方库
3. **无依赖**: 减少外部依赖，降低安全风险

**为什么选择google/uuid？**
1. **标准化**: 符合RFC 4122标准
2. **唯一性**: UUID v4保证全局唯一性
3. **性能**: 生成速度快（微秒级）

---

## 4. 构建要求说明

> ⚠️ **注意**：根据`design-rules.md`第181-330行的"部署阶段文档约束"规则，完整的Dockerfile将在部署阶段专门撰写。本章仅说明构建要求。

### 4.1 Go版本要求

- **最低版本**: Go 1.21
- **推荐版本**: Go 1.22
- **原因**: go-zero 1.6+要求Go 1.21+，泛型支持需要Go 1.18+

### 4.2 系统依赖

无特殊系统依赖，标准Linux环境即可。

### 4.3 环境变量

> 📋 **开发期约束**：以下环境变量的默认值是经过初步评估的合理值，开发期间请**严格使用这些默认值**以保证开发一致性。MVP完成后，将通过实际性能测试调整这些值，并将测试结果和优化后的值同步回本文档。

| 环境变量                     | 默认值                                     | 说明                                              |
| ---------------------------- | ------------------------------------------ | ------------------------------------------------- |
| `GATEWAY_PORT`               | 8080                                       | HTTP服务端口                                      |
| `TEMP_STORAGE_PATH`          | ./data/temp                                | 临时文件存储路径                                  |
| `LOCAL_STORAGE_PATH`         | ./data/videos                              | 任务文件存储路径                                  |
| `MAX_UPLOAD_SIZE_MB`         | 2048                                       | 最大上传文件大小（MB）                            |
| `SUPPORTED_MIME_TYPES`       | video/mp4,video/quicktime,video/x-matroska | 支持的MIME Type白名单                             |
| `API_KEY_ENCRYPTION_SECRET`  | 无                                         | **必填**，API密钥加密密钥（32字节十六进制字符串） |
| `TASK_RPC_ADDRESS`           | task:50051                                 | Task服务gRPC地址                                  |
| `HTTP_TIMEOUT_SECONDS`       | 300                                        | HTTP请求超时时间（秒）                            |
| `MAX_CONCURRENT_CONNECTIONS` | 1000                                       | 最大并发连接数                                    |
| `REDIS_HOST`                 | redis                                      | Redis主机地址                                     |
| `REDIS_PORT`                 | 6379                                       | Redis端口                                         |
| `REDIS_PASSWORD`             | 空                                         | Redis密码（可选）                                 |
| `REDIS_DB`                   | 0                                          | Redis数据库编号                                   |
| `LOG_LEVEL`                  | info                                       | 日志级别（debug, info, warn, error）              |

### 4.4 运行要求

- **内存**: 最低512MB，推荐1GB（HTTP连接池+Redis连接池）
- **磁盘**: 最低10GB（临时文件+任务文件）
- **CPU**: 最低1核，推荐2核

---

## 5. 测试策略

> ⚠️ **核心理念**：本章说明测试策略和测试覆盖范围，不包含具体测试代码。测试代码将在实现阶段编写。

### 5.1 单元测试策略

**测试目标**: 验证各个模块的独立功能正确性

**测试范围**:

| 模块                | 测试内容                         | Mock对象    |
| ------------------- | -------------------------------- | ----------- |
| **API Key加密解密** | 加密成功、解密成功、解密失败     | 无          |
| **API Key脱敏**     | 脱敏格式正确、边界情况（短密钥） | 无          |
| **MIME Type检测**   | 检测MP4、MOV、MKV、非法文件      | 无          |
| **路径安全检查**    | 路径遍历检测、符号链接检测       | 文件系统    |
| **磁盘空间检查**    | 空间充足、空间不足               | 文件系统    |
| **乐观锁逻辑**      | 版本号一致、版本号冲突           | Redis客户端 |

**为什么使用Mock？**
- **隔离外部依赖**: 单元测试不应依赖外部服务（Redis、gRPC），使用Mock模拟外部依赖
- **提升测试速度**: Mock对象响应速度快，单元测试可以在秒级完成
- **可重复性**: Mock对象行为可控，测试结果可重复

**Mock工具选择**:
- **gomock**: 官方Mock框架，支持接口Mock
- **testify/mock**: 社区流行的Mock框架，API简洁

---

### 5.2 集成测试策略

**测试目标**: 验证服务与外部依赖（Redis、Task服务）的集成正确性

**测试范围**:

| 测试场景         | 测试内容                                        | 外部依赖                     |
| ---------------- | ----------------------------------------------- | ---------------------------- |
| **Redis集成**    | 配置读写、乐观锁、连接失败                      | Redis（Docker）              |
| **Task服务集成** | CreateTask调用、GetTaskStatus调用、gRPC错误处理 | Task服务（Mock gRPC Server） |
| **文件系统集成** | 文件上传、文件下载、磁盘空间检查                | 本地文件系统                 |

**为什么需要集成测试？**
- **验证API兼容性**: Task服务的gRPC接口可能更新，集成测试可以及时发现兼容性问题
- **验证错误处理**: 单元测试无法覆盖所有外部服务错误场景，集成测试可以验证错误处理逻辑
- **验证性能**: 集成测试可以验证gRPC调用的性能（延迟、超时）

**集成测试环境**:
- **Redis**: 使用Docker启动Redis容器，测试结束后自动清理
- **Task服务**: 使用Mock gRPC Server模拟Task服务

---

### 5.3 端到端测试策略

**测试目标**: 验证完整的HTTP API流程

**测试范围**:

| 测试场景         | 测试内容                                 | 验证点                                    |
| ---------------- | ---------------------------------------- | ----------------------------------------- |
| **配置管理**     | GET /v1/settings、POST /v1/settings      | 配置读写、乐观锁、API Key脱敏             |
| **文件上传**     | POST /v1/tasks/upload                    | 文件流式保存、MIME Type检测、磁盘空间检查 |
| **任务状态查询** | GET /v1/tasks/:taskId/status             | 状态映射、URL生成                         |
| **文件下载**     | GET /v1/tasks/download/:taskId/:fileName | 流式传输、路径安全检查                    |

**为什么需要端到端测试？**
- **验证完整流程**: 端到端测试覆盖从HTTP请求到响应的完整流程，验证各个模块的集成
- **验证错误处理**: 端到端测试可以验证HTTP错误码映射、错误消息格式
- **验证性能**: 端到端测试可以验证服务的整体性能（延迟、吞吐量）

**端到端测试环境**:
- **HTTP服务**: 启动完整的Gateway服务
- **Redis**: 使用Docker启动Redis容器
- **Task服务**: 使用Mock gRPC Server

---

### 5.4 测试覆盖率目标

| 模块                | 目标覆盖率 | 说明                               |
| ------------------- | ---------- | ---------------------------------- |
| **API Key加密解密** | 95%+       | 核心逻辑简单，易于测试             |
| **路径安全检查**    | 90%+       | 包含多种边界情况                   |
| **文件流式处理**    | 85%+       | 包含文件系统交互，部分场景难以覆盖 |
| **配置管理逻辑**    | 85%+       | 包含Redis交互，部分场景难以覆盖    |
| **Handler层**       | 80%+       | 包含HTTP请求解析，部分场景难以覆盖 |

**为什么不追求100%覆盖率？**
- **成本收益**: 100%覆盖率需要大量测试代码，成本高，收益低
- **难以覆盖的场景**: 部分错误场景（如网络超时、磁盘满）难以在单元测试中模拟
- **合理目标**: 80-95%覆盖率是合理的目标，可以覆盖大部分核心逻辑

## 6. 待实现任务清单 (TODO List)

> ⚠️ **说明**：本清单按照实现顺序排列，包含任务ID、描述、预估工时、依赖关系。

### 6.1 基础设施搭建（Phase 1）

| 任务ID | 任务描述                                                | 预估工时 | 依赖关系 | 优先级 |
| ------ | ------------------------------------------------------- | -------- | -------- | ------ |
| GW-001 | 创建项目目录结构，初始化Go模块                          | 0.5h     | 无       | P0     |
| GW-002 | 编写`gateway.api`文件，定义所有API接口                  | 2h       | GW-001   | P0     |
| GW-003 | 使用`goctl`生成Handler和Types代码                       | 0.5h     | GW-002   | P0     |
| GW-004 | 编写`config.go`，加载环境变量和YAML配置                 | 1h       | GW-003   | P0     |
| GW-005 | 编写`service_context.go`，初始化Redis客户端和gRPC客户端 | 2h       | GW-004   | P0     |
| GW-006 | 编写`main.go`，启动HTTP服务器                           | 1h       | GW-005   | P0     |

**Phase 1 总工时**: 7小时

---

### 6.2 核心工具函数实现（Phase 2）

| 任务ID | 任务描述                                     | 预估工时 | 依赖关系      | 优先级 |
| ------ | -------------------------------------------- | -------- | ------------- | ------ |
| GW-007 | 实现API Key加密函数（AES-256-GCM）           | 2h       | GW-006        | P0     |
| GW-008 | 实现API Key解密函数（AES-256-GCM）           | 1h       | GW-007        | P0     |
| GW-009 | 实现API Key脱敏函数（前缀-***-后6位）        | 1h       | GW-008        | P0     |
| GW-010 | 实现MIME Type检测函数（文件头检测）          | 1.5h     | GW-006        | P0     |
| GW-011 | 实现路径安全检查函数（路径遍历+符号链接）    | 2h       | GW-006        | P0     |
| GW-012 | 实现磁盘空间检查函数（fileSize * 3 + 500MB） | 1.5h     | GW-006        | P0     |
| GW-013 | 编写工具函数的单元测试（覆盖率 > 90%）       | 4h       | GW-007~GW-012 | P0     |

**Phase 2 总工时**: 13小时

---

### 6.3 配置管理功能实现（Phase 3）

| 任务ID | 任务描述                                              | 预估工时 | 依赖关系       | 优先级 |
| ------ | ----------------------------------------------------- | -------- | -------------- | ------ |
| GW-014 | 实现`get_settings_logic.go`（从Redis读取配置）        | 3h       | GW-008, GW-009 | P0     |
| GW-015 | 实现`update_settings_logic.go`（使用Lua脚本更新配置） | 4h       | GW-007, GW-009 | P0     |
| GW-016 | 编写Lua脚本（乐观锁更新配置）                         | 1.5h     | GW-015         | P0     |
| GW-017 | 实现配置初始化逻辑（首次启动时创建默认配置）          | 2h       | GW-014         | P0     |
| GW-018 | 编写配置管理的单元测试（Mock Redis）                  | 3h       | GW-014~GW-017  | P0     |
| GW-019 | 编写配置管理的集成测试（真实Redis）                   | 2h       | GW-018         | P1     |

**Phase 3 总工时**: 15.5小时

---

### 6.4 文件上传功能实现（Phase 4）

| 任务ID | 任务描述                                   | 预估工时 | 依赖关系       | 优先级 |
| ------ | ------------------------------------------ | -------- | -------------- | ------ |
| GW-020 | 实现`upload_task_logic.go`（文件流式保存） | 4h       | GW-010, GW-012 | P0     |
| GW-021 | 实现文件大小检查逻辑（MAX_UPLOAD_SIZE_MB） | 1h       | GW-020         | P0     |
| GW-022 | 实现MIME Type白名单验证逻辑                | 1h       | GW-020         | P0     |
| GW-023 | 实现临时文件清理逻辑（defer清理）          | 1.5h     | GW-020         | P0     |
| GW-024 | 实现gRPC调用Task服务（CreateTask）         | 2h       | GW-020         | P0     |
| GW-025 | 编写文件上传的单元测试（Mock gRPC）        | 3h       | GW-020~GW-024  | P0     |
| GW-026 | 编写文件上传的集成测试（真实文件系统）     | 2h       | GW-025         | P1     |

**Phase 4 总工时**: 14.5小时

---

### 6.5 任务状态查询功能实现（Phase 5）

| 任务ID | 任务描述                                                      | 预估工时 | 依赖关系      | 优先级 |
| ------ | ------------------------------------------------------------- | -------- | ------------- | ------ |
| GW-027 | 实现`get_task_status_logic.go`（调用Task服务）                | 2h       | GW-024        | P0     |
| GW-028 | 实现状态枚举映射逻辑（PENDING/PROCESSING/COMPLETED/FAILED）   | 1h       | GW-027        | P0     |
| GW-029 | 实现下载URL生成逻辑（/v1/tasks/download/{taskId}/{fileName}） | 1h       | GW-027        | P0     |
| GW-030 | 编写任务状态查询的单元测试（Mock gRPC）                       | 2h       | GW-027~GW-029 | P0     |
| GW-031 | 编写任务状态查询的集成测试（Mock gRPC Server）                | 1.5h     | GW-030        | P1     |

**Phase 5 总工时**: 7.5小时

---

### 6.6 文件下载功能实现（Phase 6）

| 任务ID | 任务描述                                                     | 预估工时 | 依赖关系      | 优先级 |
| ------ | ------------------------------------------------------------ | -------- | ------------- | ------ |
| GW-032 | 实现`download_file_logic.go`（文件流式传输）                 | 3h       | GW-011        | P0     |
| GW-033 | 实现路径拼接逻辑（{LOCAL_STORAGE_PATH}/{taskId}/{fileName}） | 1h       | GW-032        | P0     |
| GW-034 | 实现MIME Type检测逻辑（根据扩展名）                          | 1h       | GW-032        | P0     |
| GW-035 | 实现Range请求支持（断点续传）                                | 2h       | GW-032        | P1     |
| GW-036 | 编写文件下载的单元测试（Mock文件系统）                       | 2.5h     | GW-032~GW-035 | P0     |
| GW-037 | 编写文件下载的集成测试（真实文件系统）                       | 2h       | GW-036        | P1     |

**Phase 6 总工时**: 11.5小时

---

### 6.7 中间件实现（Phase 7）

| 任务ID | 任务描述                           | 预估工时 | 依赖关系      | 优先级 |
| ------ | ---------------------------------- | -------- | ------------- | ------ |
| GW-038 | 实现CORS中间件（支持跨域请求）     | 1.5h     | GW-006        | P0     |
| GW-039 | 实现日志中间件（记录请求/响应）    | 2h       | GW-006        | P0     |
| GW-040 | 实现错误处理中间件（统一错误格式） | 2h       | GW-006        | P1     |
| GW-041 | 实现限流中间件（防止DDoS攻击）     | 2.5h     | GW-006        | P2     |
| GW-042 | 编写中间件的单元测试               | 2h       | GW-038~GW-041 | P1     |

**Phase 7 总工时**: 10小时

---

### 6.8 端到端测试与优化（Phase 8）

| 任务ID | 任务描述                             | 预估工时 | 依赖关系      | 优先级 |
| ------ | ------------------------------------ | -------- | ------------- | ------ |
| GW-043 | 编写端到端测试（完整HTTP API流程）   | 4h       | GW-006~GW-042 | P0     |
| GW-044 | 性能测试（压力测试、并发测试）       | 3h       | GW-043        | P1     |
| GW-045 | 内存泄漏检测（pprof分析）            | 2h       | GW-044        | P1     |
| GW-046 | 代码审查与优化（代码质量、性能优化） | 3h       | GW-045        | P1     |
| GW-047 | 文档完善（代码注释、README）         | 2h       | GW-046        | P1     |

**Phase 8 总工时**: 14小时

---

### 6.9 总工时统计

| Phase   | 描述                 | 总工时 | 累计工时 |
| ------- | -------------------- | ------ | -------- |
| Phase 1 | 基础设施搭建         | 7h     | 7h       |
| Phase 2 | 核心工具函数实现     | 13h    | 20h      |
| Phase 3 | 配置管理功能实现     | 15.5h  | 35.5h    |
| Phase 4 | 文件上传功能实现     | 14.5h  | 50h      |
| Phase 5 | 任务状态查询功能实现 | 7.5h   | 57.5h    |
| Phase 6 | 文件下载功能实现     | 11.5h  | 69h      |
| Phase 7 | 中间件实现           | 10h    | 79h      |
| Phase 8 | 端到端测试与优化     | 14h    | 93h      |

**总计**: 93小时（约12个工作日，按每天8小时计算）

---

### 6.10 关键里程碑

| 里程碑                       | 完成标志                  | 预计完成时间 |
| ---------------------------- | ------------------------- | ------------ |
| **M1: 基础框架搭建完成**     | Phase 1完成，服务可启动   | Day 1        |
| **M2: 核心工具函数完成**     | Phase 2完成，单元测试通过 | Day 3        |
| **M3: 配置管理功能完成**     | Phase 3完成，集成测试通过 | Day 5        |
| **M4: 文件上传功能完成**     | Phase 4完成，集成测试通过 | Day 7        |
| **M5: 任务状态查询功能完成** | Phase 5完成，集成测试通过 | Day 8        |
| **M6: 文件下载功能完成**     | Phase 6完成，集成测试通过 | Day 10       |
| **M7: 中间件实现完成**       | Phase 7完成，单元测试通过 | Day 11       |
| **M8: 端到端测试完成**       | Phase 8完成，所有测试通过 | Day 12       |

---

### 6.11 风险与缓解措施

| 风险                    | 影响 | 概率 | 缓解措施                                 |
| ----------------------- | ---- | ---- | ---------------------------------------- |
| **gRPC接口变更**        | 高   | 中   | 与Task服务团队保持沟通，及时同步接口变更 |
| **Redis连接不稳定**     | 中   | 低   | 实现连接池和重试机制，增加健康检查       |
| **文件上传性能问题**    | 中   | 中   | 使用流式处理，避免内存占用过高           |
| **磁盘空间不足**        | 高   | 中   | 实现磁盘空间预检，定期清理过期文件       |
| **API Key加密密钥泄露** | 高   | 低   | 使用环境变量管理密钥，禁止硬编码         |

---

## 7. 与第二层文档的对应关系

本文档严格遵循第二层文档`Gateway-design.md` v5.9的设计，核心对应关系如下：

| 第二层文档章节        | 第三层文档章节       | 对应关系说明                             |
| --------------------- | -------------------- | ---------------------------------------- |
| **1. 服务定位与职责** | 2.1, 2.2, 2.8        | 文件流式处理、磁盘空间预检、错误处理策略 |
| **2. 依赖服务**       | 3. 依赖库清单        | Redis客户端、gRPC客户端选型              |
| **3. 关键配置项定义** | 4.3 环境变量         | 环境变量定义与默认值                     |
| **5. 接口定义**       | 6.3~6.6 待实现任务   | API接口实现任务                          |
| **6. 关键逻辑步骤**   | 2.1~2.8 核心实现决策 | 逻辑步骤的实现决策                       |

---

## 8. 文档审查清单

根据`REVIEW-CHECKLIST.md`第107-151行的第三层文档审查清单，本文档已完成以下检查：

- [x] **完整性检查**：包含项目结构、核心实现决策、依赖库清单、构建要求、测试策略、待实现任务清单
- [x] **层次分明检查**：核心实现决策专注于"为什么"，避免大段代码复制粘贴
- [x] **代码片段规则检查**：所有代码片段 ≤20行，优先使用伪代码
- [x] **部署文档约束检查**：未包含完整Dockerfile，明确标注"完整部署文档将在部署阶段专门撰写"
- [x] **准确性检查**：与第二层文档`Gateway-design.md` v5.9一致
- [x] **一致性检查**：与第一层文档`Base-Design.md` v2.2一致

---

**文档结束**
