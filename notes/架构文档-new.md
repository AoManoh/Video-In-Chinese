# **1. é¡¹ç›®åŸºçŸ³æ–‡æ¡£ï¼šè§†é¢‘ç¿»è¯‘æœåŠ¡ (V1.0)**



æ–‡æ¡£ç‰ˆæœ¬: 1.1

æœ€åŽæ›´æ–°: 2025å¹´10æœˆ30æ—¥

è´Ÿè´£äºº: (AIæŠ€æœ¯åˆä¼™äºº)



### **ç‰ˆæœ¬åŽ†å²**



- **v1.1 (2025-10-30):**
	- **æ ¸å¿ƒæž¶æž„å˜æ›´**: æ ¹æ®æœ€ç»ˆå†³ç­–ï¼Œå°†æž¶æž„ä»Žâ€œçº¯APIæ–¹æ¡ˆâ€æ˜Žç¡®ä¸ºâ€œ**æ··åˆæž¶æž„**â€ã€‚æ ¸å¿ƒçš„å£°éŸ³å…‹éš†åŠŸèƒ½ç”±æœ¬åœ°å¼€æºå¾®æœåŠ¡å®žçŽ°ï¼Œå…¶ä»–AIèƒ½åŠ›ç”±å¤–éƒ¨APIå®žçŽ°ã€‚
	- **å¢žåŠ ç¡¬ä»¶ä¾èµ–**: æ˜Žç¡®äº†é¡¹ç›®éƒ¨ç½²**å¿…é¡»ä¾èµ–NVIDIA GPU**åŠNVIDIA Container Toolkitã€‚
	- **å¼•å…¥å›¾æ ‡è¡¨æ ¼**: åœ¨`1.3 æŠ€æœ¯æ ˆé€‰åž‹`ä¸­å¼•å…¥äº†å¸¦å›¾æ ‡çš„è¡¨æ ¼ï¼Œä»¥æ›´ç›´è§‚åœ°å±•ç¤ºå„æ¨¡å—çš„é€‰åž‹åŠå…¶åŽŸå› ã€‚
	- **è°ƒæ•´é¡¹ç›®ç»“æž„**: åœ¨`1.4 é¡¹ç›®å·¥ç¨‹ç»“æž„`ä¸­å¢žåŠ äº†`ai-workers`å±‚ï¼Œä»¥å®¹çº³æ–°çš„Pythonå¾®æœåŠ¡ã€‚
	- **æ›´æ–°å·¥ä½œæµ**: åœ¨`1.5`å’Œ`4.2`ç« èŠ‚ä¸­ï¼Œå°†å£°éŸ³å…‹éš†æ­¥éª¤æ˜Žç¡®æŒ‡å‘**æœ¬åœ°gRPCè°ƒç”¨**ã€‚
	- **APIå®šä¹‰å‡€åŒ–**: åœ¨`2.2`ç« èŠ‚ä¸­ï¼Œä»Ž`gateway`æœåŠ¡çš„é…ç½®æŽ¥å£ä¸­**ç§»é™¤äº†å£°éŸ³å…‹éš†ç›¸å…³çš„API Keyå­—æ®µ**ï¼Œå› ä¸ºå®ƒå·²æˆä¸ºå†…éƒ¨æœåŠ¡ã€‚
- **v1.0 (2025-10-29):** åˆå§‹æ–‡æ¡£åˆ›å»ºã€‚

------



## **æ–‡æ¡£å±‚æ¬¡è¯´æ˜Ž**



æœ¬é¡¹ç›®é‡‡ç”¨ä¸‰å±‚æ–‡æ¡£ä½“ç³»ï¼Œç¡®ä¿ä»Žå®è§‚æž¶æž„åˆ°å…·ä½“å®žçŽ°çš„æ¸…æ™°åˆ’åˆ†ï¼š

**ç¬¬ä¸€å±‚ï¼šå®è§‚æž¶æž„è®¾è®¡ï¼ˆæœ¬æ–‡æ¡£ï¼‰**

- å®šä½ï¼šé¡¹ç›®çš„"å®ªæ³•"ï¼Œå®šä¹‰ç³»ç»Ÿè¾¹ç•Œã€æ ¸å¿ƒç»„ä»¶ã€æŠ€æœ¯æ ˆå’Œé«˜çº§å·¥ä½œæµ
- å†…å®¹ï¼šé¡¹ç›®æ„¿æ™¯ã€æž¶æž„æ¨¡å¼ã€æŠ€æœ¯é€‰åž‹ã€æ ¸å¿ƒä¸šåŠ¡æµç¨‹ã€æž¶æž„å†³ç­–è®°å½•ï¼ˆADRï¼‰
- ç¨³å®šæ€§ï¼šé«˜åº¦ç¨³å®šï¼Œæ‰€æœ‰åŽç»­è®¾è®¡ä¸å¾—è¿èƒŒæœ¬æ–‡æ¡£

**ç¬¬äºŒå±‚ï¼šæ¨¡å—ç»†åˆ†è®¾è®¡ï¼ˆå¾…åˆ›å»ºï¼‰**

- å®šä½ï¼šé¡¹ç›®çš„"éƒ¨é—¨æ³•"ï¼ŒæŒ‡å¯¼å…·ä½“ç¼–ç å·¥ä½œçš„ç›´æŽ¥è“å›¾
- å†…å®¹ï¼šæ¯ä¸ªå¾®æœåŠ¡çš„å®Œæ•´ API å¥‘çº¦ï¼ˆ.api / .proto æ–‡ä»¶ï¼‰ã€è¯¦ç»†æ•°æ®ç»“æž„ã€æ ¸å¿ƒé€»è¾‘ä¼ªä»£ç ã€æœåŠ¡äº¤äº’æ—¶åºå›¾
- äº§å‡ºç‰©ï¼šã€ŠGateway æœåŠ¡è®¾è®¡æ–‡æ¡£ã€‹ã€ã€ŠTask æœåŠ¡è®¾è®¡æ–‡æ¡£ã€‹ã€ã€ŠProcessor æœåŠ¡è®¾è®¡æ–‡æ¡£ã€‹ã€ã€ŠTTS Worker æœåŠ¡è®¾è®¡æ–‡æ¡£ã€‹

**ç¬¬ä¸‰å±‚ï¼šä»£ç å®žçŽ°ä¸ŽæŽ¥å£æ–‡æ¡£ï¼ˆå¼€å‘é˜¶æ®µï¼‰**

- å®šä½ï¼šæœ€ç»ˆå¯è¿è¡Œã€å¯äº¤äº’çš„äº§ç‰©
- å†…å®¹ï¼šç¬¦åˆç¬¬äºŒå±‚è®¾è®¡çš„ Go/Python ä»£ç ã€è‡ªåŠ¨ç”Ÿæˆçš„ Swagger/gRPC æ–‡æ¡£ã€å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

------



## **1.1 é¡¹ç›®æ„¿æ™¯ä¸ŽMVPèŒƒå›´**



- **é¡¹ç›®æ„¿æ™¯**: åˆ›å»ºä¸€ä¸ª**å•ç”¨æˆ·è‡ªéƒ¨ç½²æœåŠ¡**ï¼Œèƒ½å¤Ÿå°†åŒ…å«å¤–è¯­å¯¹è¯çš„è§†é¢‘ï¼ˆåˆæœŸä¸ºè‹±è¯­ï¼‰æ— ç¼ç¿»è¯‘ä¸ºä¸­æ–‡å¯¹è¯ã€‚æ ¸å¿ƒç›®æ ‡æ˜¯ä¸ä»…ç¿»è¯‘å†…å®¹ï¼Œè¿˜è¦æœ€å¤§ç¨‹åº¦åœ°ä¿ç•™åŽŸè¯´è¯è€…çš„**æƒ…æ„Ÿã€è¯­è°ƒå’ŒèŠ‚å¥**ï¼Œæä¾›"èº«ä¸´å…¶å¢ƒ"çš„æ¯è¯­åŒ–ä½“éªŒã€‚
- **æ³¨æ˜Ž**: å½“å‰ MVP äº§å“ä»…ä¾›ç”¨æˆ·æ‹‰å–ä»£ç åŽï¼Œé€šè¿‡ Docker ä¸€é”®éƒ¨ç½²åœ¨æœ¬åœ°æˆ–è‡ªæœ‰æœåŠ¡å™¨ä¸Šä½¿ç”¨ã€‚**æœåŠ¡å™¨å¿…é¡»é…å¤‡æ”¯æŒCUDAçš„NVIDIA GPU**ï¼Œä»¥è¿è¡Œæœ¬åœ°åŒ–çš„å£°éŸ³å…‹éš†æœåŠ¡ã€‚
- **MVPæ ¸å¿ƒèŒƒå›´**:
	- **äº§å“å½¢æ€**: ä¸€ä¸ªæ— éœ€ç™»å½•çš„å•é¡µé¢Webåº”ç”¨ã€‚
	- **æ ¸å¿ƒæµç¨‹**: ç”¨æˆ·é…ç½® API å¯†é’¥ -> ä¸Šä¼ è§†é¢‘æ–‡ä»¶ -> æœåŠ¡è¿›è¡Œå¼‚æ­¥å¤„ç† -> å‰ç«¯é€šè¿‡è½®è¯¢æœºåˆ¶èŽ·å–å¤„ç†çŠ¶æ€ -> å¤„ç†å®ŒæˆåŽæä¾›å¯ä¾›ä¸‹è½½çš„ã€æ›¿æ¢äº†ä¸­æ–‡éŸ³è½¨çš„è§†é¢‘æ–‡ä»¶ã€‚
	- **æŠ€æœ¯è·¯å¾„**: é‡‡ç”¨**æ··åˆå¤„ç†æµç¨‹**ã€‚æ ¸å¿ƒçš„**å£°éŸ³å…‹éš†**èƒ½åŠ›é€šè¿‡**æœ¬åœ°å¼€æºæ¨¡åž‹**å®žçŽ°ï¼Œä»¥ç¡®ä¿éšç§å’Œé›¶æˆæœ¬ï¼›å…¶ä»–AIèƒ½åŠ›ï¼ˆASRã€ç¿»è¯‘ç­‰ï¼‰é€šè¿‡è°ƒç”¨å¤§æ¨¡åž‹åŽ‚å•† API å®žçŽ°ã€‚V2.0 å°†æ‰©å±•ç«¯åˆ°ç«¯ S2STï¼ˆAI Dubbingï¼‰æ¨¡å¼ã€‚



## **1.2 ç³»ç»Ÿæž¶æž„ä¸Žè®¾è®¡**



- **æž¶æž„æ¨¡å¼**: é‡‡ç”¨**åˆ†å¸ƒå¼å¾®æœåŠ¡æž¶æž„**ï¼Œæ˜Žç¡®åˆ’åˆ†**æŽ¥å…¥å±‚ (app)**ã€**GoæœåŠ¡å±‚ (mcp)** å’Œ **Python AIå·¥ä½œèŠ‚ç‚¹ (ai-workers)**ã€‚
	- **æŽ¥å…¥å±‚ (`server/app`)**: è´Ÿè´£å¯¹å¤–æä¾› **RESTful API**ï¼Œä½œä¸ºæµé‡å…¥å£ã€‚
	- **GoæœåŠ¡å±‚ (`server/mcp`)**: è´Ÿè´£å®žçŽ°æ‰€æœ‰æ ¸å¿ƒGoä¸šåŠ¡é€»è¾‘ï¼Œä»¥å†…éƒ¨ **gRPC** æœåŠ¡çš„å½¢å¼å­˜åœ¨ã€‚
	- **AIå·¥ä½œèŠ‚ç‚¹ (`ai-workers`)**: è´Ÿè´£æ‰§è¡Œè®¡ç®—å¯†é›†åž‹çš„AIä»»åŠ¡ï¼ˆå¦‚å£°éŸ³å…‹éš†ï¼‰ï¼Œä»¥ç‹¬ç«‹çš„Python gRPCå¾®æœåŠ¡å½¢å¼å­˜åœ¨ã€‚
- **æ ¸å¿ƒç»„ä»¶äº¤äº’**:
	- **å¼‚æ­¥ä»»åŠ¡å¤„ç†**: `task` æœåŠ¡é€šè¿‡ gRPC è°ƒç”¨ `processor` æœåŠ¡ï¼Œ`processor` æœåŠ¡åœ¨ Goroutine ä¸­å¼‚æ­¥æ‰§è¡Œå¤„ç†ä»»åŠ¡ï¼Œå¹¶åœ¨éœ€è¦æ—¶é€šè¿‡ gRPC è°ƒç”¨ `tts-worker` ç­‰AIæœåŠ¡ã€‚
	- **æ–‡ä»¶å­˜å‚¨æ–¹æ¡ˆ**: MVP é˜¶æ®µä½¿ç”¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œé€šè¿‡ Storage æŽ¥å£æŠ½è±¡ã€‚
	- **çŠ¶æ€ç®¡ç†**: MVPé˜¶æ®µï¼Œä»»åŠ¡çš„å®žæ—¶çŠ¶æ€å­˜å‚¨åœ¨ **Redis** ä¸­ã€‚
	- **åº”ç”¨é…ç½®ç®¡ç†**: APIå¯†é’¥ç­‰åº”ç”¨é…ç½®å­˜å‚¨åœ¨ **Redis** ä¸­ï¼Œå¹¶ä½¿ç”¨AES-256-GCMåŠ å¯†ã€‚



## **1.3 æŠ€æœ¯æ ˆé€‰åž‹**



| **å›¾æ ‡** | **æ¨¡å— (Module)**                     | **æ ¸å¿ƒä»»åŠ¡ (Core Task)**                                     | **é‡‡ç”¨æ–¹æ¡ˆ (Adopted Solution)**                   | **é‡‡ç”¨åŽŸå›  (Rationale)**                                     |
| -------- | ------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------- | ------------------------------------------------------------ |
| ðŸ–¥ï¸        | **å‰ç«¯ (Frontend)**                   | æä¾›ç”¨æˆ·äº¤äº’ç•Œé¢ï¼Œè´Ÿè´£è§†é¢‘ä¸Šä¼ ã€API Keyé…ç½®å’Œä»»åŠ¡çŠ¶æ€å±•ç¤ºã€‚  | **Vue 3 (Viteæž„å»º)**                              | çŽ°ä»£åŒ–å‰ç«¯æ¡†æž¶ï¼Œå¼€å‘æ•ˆçŽ‡é«˜ï¼Œç”Ÿæ€æˆç†Ÿï¼Œéžå¸¸é€‚åˆå¿«é€Ÿæž„å»ºåŠŸèƒ½ä¸°å¯Œçš„å•é¡µåº”ç”¨MVPã€‚ |
| âš™ï¸        | **åŽç«¯æ€»æŽ§ (Backend Orchestrator)**   | ä½œä¸ºç³»ç»Ÿæ€»æŽ§ï¼ŒæŽ¥æ”¶å‰ç«¯è¯·æ±‚ï¼Œç¼–æŽ’æ•´ä¸ªå·¥ä½œæµï¼Œè°ƒç”¨å…¶ä»–æœåŠ¡ï¼Œå¹¶æ‰§è¡Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚æ—¶é•¿å¯¹é½ï¼‰ã€‚ | **Go + GoZero æ¡†æž¶**                              | Goè¯­è¨€æ€§èƒ½å“è¶Šï¼Œå¹¶å‘å¤„ç†èƒ½åŠ›å¼ºã€‚GoZeroæ¡†æž¶æä¾›äº†æˆç†Ÿçš„å¾®æœåŠ¡æ²»ç†ç»“æž„ï¼ˆRESTfulç½‘å…³ + gRPCæœåŠ¡ï¼‰ï¼Œå®Œç¾Žå¥‘åˆæœ¬é¡¹ç›®æž¶æž„ã€‚ |
| ðŸŽžï¸        | **åª’ä½“å¤„ç† (Media Processing)**       | è´Ÿè´£è§†é¢‘çš„æ‹†è§£ï¼ˆæå–éŸ³è§†é¢‘æµï¼‰ä¸Žæœ€ç»ˆçš„åˆæˆï¼ˆåˆå¹¶æ–°éŸ³è½¨ä¸Žç”»é¢ï¼‰ã€‚ | **Go è°ƒç”¨ FFmpeg**                                | FFmpegæ˜¯éŸ³è§†é¢‘å¤„ç†çš„â€œç‘žå£«å†›åˆ€â€ï¼ŒåŠŸèƒ½å¼ºå¤§ã€æ€§èƒ½å¯é ä¸”å®Œå…¨å…è´¹ã€‚é€šè¿‡Goè°ƒç”¨æ˜¯æœ€é«˜æ•ˆã€æœ€ç¨³å®šçš„æ–¹æ¡ˆã€‚ |
| ðŸŽ¤        | **å£°éŸ³å…‹éš† (Voice Cloning)**          | **(æ ¸å¿ƒ)** ä½¿ç”¨ç”¨æˆ·æä¾›çš„å‚è€ƒéŸ³é¢‘ï¼Œå°†ç¿»è¯‘å¥½çš„ä¸­æ–‡æ–‡æœ¬è½¬æ¢ä¸ºä¸ŽåŽŸå£°é«˜åº¦ç›¸ä¼¼çš„è¯­éŸ³ã€‚ | **Pythonå¾®æœåŠ¡ (gRPC) + å°è£…GTP-SoVITSæŽ¨ç†æ ¸å¿ƒ**  | **æ ¸å¿ƒç«žäº‰åŠ›ã€‚** å°†æœ€æ•æ„Ÿã€æˆæœ¬æœ€é«˜çš„å£°éŸ³å…‹éš†ä¿ç•™åœ¨æœ¬åœ°ï¼Œ1) **è§£å†³äº†æ ¸å¿ƒéšç§é—®é¢˜**ï¼ˆå£°éŸ³ä¸ä¸Šä¼ ï¼‰ï¼›2) **è§£å†³äº†æ ¸å¿ƒæˆæœ¬é—®é¢˜**ï¼ˆä¸ä¾èµ–æ˜‚è´µAPIï¼‰ã€‚ |
| ðŸ”Œ        | **å¤–éƒ¨AIæœåŠ¡ (External AI Services)** | å¤„ç†æ ‡å‡†åŒ–çš„AIä»»åŠ¡ï¼ŒåŒ…æ‹¬è¯­éŸ³è½¬å½•(ASR)ã€è¯´è¯äººæ—¥å¿—å’Œæ–‡æœ¬ç¿»è¯‘ã€‚ | **ç”¨æˆ·è‡ªé€‰API + GoåŽç«¯é€‚é… (ç«å±±/è°·æ­Œ/OpenAIç­‰)** | **å¹³è¡¡æ–¹æ¡ˆã€‚** é¿å…äº†å°†æ‰€æœ‰AIæ¨¡åž‹æœ¬åœ°åŒ–çš„å·¨å¤§å¤æ‚æ€§ï¼Œé™ä½Žäº†éƒ¨ç½²é—¨æ§›ï¼ˆç›¸å¯¹äºŽâ€œå®Œå…¨æœ¬åœ°åŒ–â€ï¼‰ï¼ŒåŒæ—¶ç»™äºˆç”¨æˆ·é€‰æ‹©æƒå’Œæˆæœ¬æŽ§åˆ¶æƒã€‚ |
| ðŸ³        | **éƒ¨ç½² (Deployment)**                 | å°†æ‰€æœ‰æœåŠ¡ï¼ˆå‰ç«¯ã€åŽç«¯ã€AIå¾®æœåŠ¡ï¼‰æ‰“åŒ…æˆä¸€ä¸ªç»Ÿä¸€çš„ã€å¯ä¸€é”®å¯åŠ¨çš„åº”ç”¨çŽ¯å¢ƒã€‚ | **Docker Compose**                                | **ç®€åŒ–éƒ¨ç½²ã€‚** å°½ç®¡é•œåƒä½“ç§¯å¤§ï¼ˆ15-25GBï¼‰ï¼Œä½†Dockeræ˜¯ç®¡ç†å¤æ‚å¤šæœåŠ¡ä¾èµ–ï¼ˆç‰¹åˆ«æ˜¯å¸¦GPUçš„PythonçŽ¯å¢ƒï¼‰çš„æœ€ä½³å·¥å…·ï¼Œæžå¤§é™ä½Žäº†ç”¨æˆ·çš„éƒ¨ç½²å’Œé…ç½®éš¾åº¦ã€‚ |



## **1.4 é¡¹ç›®å·¥ç¨‹ç»“æž„**



```
video-translator/
â”œâ”€â”€ server/          # Goå¾®æœåŠ¡ (ä¸šåŠ¡é€»è¾‘/æœåŠ¡å±‚)
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â””â”€â”€ gateway/ # RESTful API æœåŠ¡ (æŽ¥å…¥å±‚)
â”‚   â”œâ”€â”€ mcp/
â”‚   â”‚   â”œâ”€â”€ task/
â”‚   â”‚   â””â”€â”€ processor/
â”‚   â””â”€â”€ common/
â”œâ”€â”€ ai-workers/      # Python AIå¾®æœåŠ¡ (AIå·¥ä½œèŠ‚ç‚¹)
â”‚   â””â”€â”€ tts-worker/  # å£°éŸ³å…‹éš†æœåŠ¡
â”œâ”€â”€ client/
â”‚   â””â”€â”€ web/         # å‰ç«¯é¡¹ç›® (Vue, React, etc.)
â”œâ”€â”€ etc/             # å…¨å±€éƒ¨ç½²é…ç½®æ–‡ä»¶
â””â”€â”€ go.mod
```



## **1.5 æ ¸å¿ƒä¸šåŠ¡å·¥ä½œæµ (`processor`æœåŠ¡)**



1. **æŽ¥æ”¶ä»»åŠ¡**: `task` æœåŠ¡é€šè¿‡ gRPC è°ƒç”¨ `processor` æœåŠ¡ã€‚
2. **å¹¶å‘æŽ§åˆ¶**: å°è¯•èŽ·å– worker æ§½ä½ã€‚
3. **çŠ¶æ€æ›´æ–°**: æ›´æ–°Redisä¸­ä»»åŠ¡çŠ¶æ€ä¸º `PROCESSING`ã€‚
4. **æ–‡ä»¶å‡†å¤‡**: è¯»å–åŽŸå§‹è§†é¢‘ã€‚
5. **éŸ³è½¨åˆ†ç¦»**: è°ƒç”¨ `ffmpeg`ã€‚
6. **è¯­éŸ³è¯†åˆ«**: è°ƒç”¨ **å¤–éƒ¨ ASR æœåŠ¡** ç»Ÿä¸€æŽ¥å£ã€‚
7. **æ–‡æœ¬æ¶¦è‰²**ï¼ˆå¯é€‰ï¼‰: è°ƒç”¨ **å¤–éƒ¨ LLM æœåŠ¡** ç»Ÿä¸€æŽ¥å£ã€‚
8. **æ–‡æœ¬ç¿»è¯‘**: è°ƒç”¨ **å¤–éƒ¨ Translation æœåŠ¡** ç»Ÿä¸€æŽ¥å£ã€‚
9. **è¯‘æ–‡ä¼˜åŒ–**ï¼ˆå¯é€‰ï¼‰: è°ƒç”¨ **å¤–éƒ¨ LLM æœåŠ¡** ç»Ÿä¸€æŽ¥å£ã€‚
10. **è¯­éŸ³åˆæˆ**: é€šè¿‡gRPCè°ƒç”¨**æœ¬åœ° `tts-worker` å¾®æœåŠ¡**ï¼Œç”Ÿæˆä¸­æ–‡éŸ³é¢‘ã€‚
11. **éŸ³è½¨åˆæˆ**: è°ƒç”¨ `ffmpeg`ã€‚
12. **ç»“æžœä¿å­˜**: ä¿å­˜æœ€ç»ˆè§†é¢‘ã€‚
13. **çŠ¶æ€ç»ˆæ›´**: æ›´æ–°Redisä¸­ä»»åŠ¡çŠ¶æ€ä¸º `COMPLETED`ã€‚
14. **å¼‚å¸¸å¤„ç†**: å…¨ç¨‹ç›‘æŽ§ï¼Œå¤±è´¥åˆ™æ›´æ–°çŠ¶æ€ä¸º `FAILED`ã€‚



## **1.6 å¤„ç†æ¨¡å¼**



æœ¬é¡¹ç›®æ”¯æŒä¸¤ç§è§†é¢‘ç¿»è¯‘å¤„ç†æ¨¡å¼ã€‚MVP é˜¶æ®µï¼ˆV1.0ï¼‰å®žçŽ°æ ‡å‡†æ¨¡å¼ã€‚



### **æ ‡å‡†æ¨¡å¼ï¼ˆCascaded Modeï¼‰**



æµç¨‹: å¤–éƒ¨ASR â†’ å¤–éƒ¨LLM â†’ å¤–éƒ¨Translation â†’ å¤–éƒ¨LLM â†’ æœ¬åœ°Voice Cloning â†’ è§†é¢‘åˆæˆ

ç‰¹ç‚¹: é«˜å¯æŽ§æ€§ã€ç¿»è¯‘å‡†ç¡®ã€æˆæœ¬çµæ´»ã€æ ¸å¿ƒéšç§å—ä¿æŠ¤ã€‚



### **AI é…éŸ³æ¨¡å¼ï¼ˆS2ST Modeï¼‰**



æµç¨‹: å¤–éƒ¨AI Dubbing Service â†’ è§†é¢‘åˆæˆ

ç‰¹ç‚¹: æƒ…æ„Ÿä¿ç•™ä¼˜ç§€ã€æµç¨‹ç®€å•ï¼Œä½†ä¸ºé»‘ç›’å¤„ç†ï¼Œä¸”å£°éŸ³éšç§ä¼šæ³„éœ²ç»™åŽ‚å•†ã€‚V2.0æ‰©å±•ã€‚

------



# **2. `gateway`æœåŠ¡æž¶æž„è®¾è®¡**





## **2.1 æœåŠ¡å®šä½ä¸Žæ ¸å¿ƒèŒè´£**



`gateway` æœåŠ¡æ˜¯ç³»ç»Ÿçš„**å”¯ä¸€æµé‡å…¥å£**å’Œ**åè®®è½¬æ¢ç½‘å…³**ã€‚å…¶æ ¸å¿ƒèŒè´£ä¸¥æ ¼é™å®šäºŽï¼šHTTPåè®®å¤„ç†ã€è¯·æ±‚æ ¡éªŒã€æ–‡ä»¶æµå¼å¤„ç†ã€åè®®è½¬æ¢ã€å“åº”æ ¼å¼åŒ–ã€æ–‡ä»¶ä¸‹è½½æœåŠ¡ã€åº”ç”¨é…ç½®ç®¡ç†ã€‚



## **2.2 MVPæŽ¥å£å®šä¹‰ (`gateway.api`)**



Go

```
syntax = "v1"

info(
  title: "Video Translation Service API"
  desc: "API for creating and managing video translation tasks."
  author: "Our Team"
  version: "1.1.0"
)

type (
  // èŽ·å–åº”ç”¨é…ç½®çš„å“åº”ä½“
  GetSettingsResponse {
    Version int64 `json:"version"` // é…ç½®ç‰ˆæœ¬å·ï¼ˆä¹è§‚é”ï¼‰
    ProcessingMode string `json:"processing_mode"` // standard, s2st

    // ASR æœåŠ¡é…ç½®
    AsrProvider string `json:"asr_provider"`
    AsrApiKey   string `json:"asr_api_key"`   // è„±æ•åŽçš„ API Key
    AsrEndpoint string `json:"asr_endpoint,omitempty"`

    // æ–‡æœ¬æ¶¦è‰²é…ç½®ï¼ˆå¯é€‰ï¼‰
    PolishingEnabled  bool   `json:"polishing_enabled"`
    PolishingProvider string `json:"polishing_provider,omitempty"`
    PolishingApiKey   string `json:"polishing_api_key,omitempty"`

    // ç¿»è¯‘æœåŠ¡é…ç½®
    TranslationProvider string `json:"translation_provider"`
    TranslationApiKey   string `json:"translation_api_key"`
    TranslationEndpoint string `json:"translation_endpoint,omitempty"`

    // è¯‘æ–‡ä¼˜åŒ–é…ç½®ï¼ˆå¯é€‰ï¼‰
    OptimizationEnabled  bool   `json:"optimization_enabled"`
    OptimizationProvider string `json:"optimization_provider,omitempty"`
    OptimizationApiKey   string `json:"optimization_api_key,omitempty"`

    // S2ST æœåŠ¡é…ç½®ï¼ˆV2.0ï¼‰
    S2stProvider string `json:"s2st_provider,omitempty"`
    S2stApiKey   string `json:"s2st_api_key,omitempty"`
  }

  // æ›´æ–°åº”ç”¨é…ç½®çš„è¯·æ±‚ä½“
  UpdateSettingsRequest {
    Version int64 `json:"version"` // ä¹è§‚é”ç‰ˆæœ¬å·
    ProcessingMode string `json:"processing_mode,omitempty"`
    
    // ASR æœåŠ¡é…ç½®
    AsrProvider string `json:"asr_provider,omitempty"`
    AsrApiKey   string `json:"asr_api_key,omitempty"` // å¦‚æžœæ˜¯è„±æ•å€¼ï¼ŒåŽç«¯ä¿æŒåŽŸå€¼
    AsrEndpoint string `json:"asr_endpoint,omitempty"`

    // æ–‡æœ¬æ¶¦è‰²é…ç½®
    PolishingEnabled  *bool  `json:"polishing_enabled,omitempty"`
    PolishingProvider string `json:"polishing_provider,omitempty"`
    PolishingApiKey   string `json:"polishing_api_key,omitempty"`

    // ç¿»è¯‘æœåŠ¡é…ç½®
    TranslationProvider string `json:"translation_provider,omitempty"`
    TranslationApiKey   string `json:"translation_api_key,omitempty"`
    TranslationEndpoint string `json:"translation_endpoint,omitempty"`

    // è¯‘æ–‡ä¼˜åŒ–é…ç½®
    OptimizationEnabled  *bool  `json:"optimization_enabled,omitempty"`
    OptimizationProvider string `json:"optimization_provider,omitempty"`
    OptimizationApiKey   string `json:"optimization_api_key,omitempty"`
    
    // S2ST æœåŠ¡é…ç½®ï¼ˆV2.0ï¼‰
    S2stProvider string `json:"s2st_provider,omitempty"`
    S2stApiKey   string `json:"s2st_api_key,omitempty"`
  }
  
  // UpdateSettingsResponse å®šä¹‰
  UpdateSettingsResponse {
    Version int64  `json:"version"` // æ›´æ–°åŽçš„ç‰ˆæœ¬å·
    Message string `json:"message"`
  }

  // UploadTaskResponse å®šä¹‰
  UploadTaskResponse {
    TaskId string `json:"task_id"`
  }

  // GetTaskStatusRequest å®šä¹‰
  GetTaskStatusRequest {
    TaskId string `path:"taskId"`
  }

  // GetTaskStatusResponse å®šä¹‰
  GetTaskStatusResponse {
    TaskId       string `json:"task_id"`
    Status       string `json:"status"` // PENDING, PROCESSING, COMPLETED, FAILED
    ResultUrl    string `json:"result_url,omitempty"`    // ä»…åœ¨COMPLETEDæ—¶å‡ºçŽ°
    ErrorMessage string `json:"error_message,omitempty"` // ä»…åœ¨FAILEDæ—¶å‡ºçŽ°
  }

  // DownloadFileRequest å®šä¹‰
  DownloadFileRequest {
    Key string `path:"key"`
  }
)

@server(
  group: settings
  prefix: /v1/settings
)
service gateway-api {
  @doc("Get application settings")
  @handler getSettings
  get / returns (GetSettingsResponse)

  @doc("Update application settings")
  @handler updateSettings
  post / (UpdateSettingsRequest) returns (UpdateSettingsResponse)
}

@server(
  group: task
  prefix: /v1/tasks
)
service gateway-api {
  @doc("Upload a video file to create a translation task")
  @handler uploadTask
  post /upload (UploadTaskResponse)

  @doc("Get the status of a specific task by its ID")
  @handler getTaskStatus
  get /:taskId/status (GetTaskStatusRequest) returns (GetTaskStatusResponse)

  @doc("Download the result video file")
  @handler downloadFile
  get /download/:key
}
```



## **2.3 å…³é”®é€»è¾‘æµç¨‹ (`internal/logic`)**



- **`getSettingsLogic` / `updateSettingsLogic`**: é€»è¾‘ä¸å˜ï¼Œä½†å¤„ç†çš„å­—æ®µä¸­**ä¸åŒ…å«**å£°éŸ³å…‹éš†(Voice Cloning)ç›¸å…³çš„Providerå’ŒApiKeyï¼Œå› ä¸ºå®ƒæ˜¯å†…ç½®æœåŠ¡ã€‚
- **`uploadTaskLogic`**: æ ¸å¿ƒé€»è¾‘æ˜¯æŽ¥æ”¶æ–‡ä»¶ã€å­˜åˆ°æœ¬åœ°ã€å¹¶é€šè¿‡gRPCè°ƒç”¨`task`æœåŠ¡ã€‚
- **`getTaskStatusLogic`**: æ ¸å¿ƒé€»è¾‘æ˜¯é€šè¿‡gRPCè°ƒç”¨`task`æœåŠ¡æŸ¥è¯¢çŠ¶æ€ã€‚
- **`downloadFileLogic`**: æ ¸å¿ƒé€»è¾‘æ˜¯ä»Žæœ¬åœ°å­˜å‚¨æµå¼è¿”å›žæ–‡ä»¶ã€‚



## **2.4 MVPçš„å±€é™æ€§ä¸Žæœªæ¥è¿­ä»£æ–¹å‘**



ï¼ˆå†…å®¹ä¿æŒä¸å˜ï¼ŒåŒ…æ‹¬ï¼šå¤„ç†è¿‡ç¨‹ä¸é€æ˜Žã€é”™è¯¯æç¤ºä¸å‹å¥½ã€è½®è¯¢æœºåˆ¶ã€ç¼ºå°‘ç”¨æˆ·ç³»ç»Ÿã€ä»»åŠ¡ç®¡ç†ã€ä¸Šä¼ ä½“éªŒã€ç¼ºå°‘è¿ç»´æŽ¥å£ç­‰ã€‚ï¼‰

------



# **3. `task`æœåŠ¡æž¶æž„è®¾è®¡**





## **3.1 æœåŠ¡å®šä½ä¸Žæ ¸å¿ƒèŒè´£**



`task` æœåŠ¡ (`server/mcp/task`) æ˜¯ä¸€ä¸ªå†…éƒ¨gRPCæœåŠ¡ï¼Œå®šä½ä¸º**ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨**ã€‚å®ƒè´Ÿè´£æŽ¥æ”¶ä»»åŠ¡åˆ›å»ºè¯·æ±‚ï¼ŒæŒä¹…åŒ–ä»»åŠ¡çŠ¶æ€ï¼Œå¹¶**ç›´æŽ¥ã€åŒæ­¥åœ°è§¦å‘**`processor`æœåŠ¡å¼€å§‹å¼‚æ­¥å¤„ç†ã€‚



## **3.2 gRPCæŽ¥å£å®šä¹‰ (`task.proto`)**



Protocol Buffers

```
syntax = "proto3";

package task.v1;
option go_package = "github.com/our-org/video-translator/server/mcp/task/pb";

enum TaskStatus {
  UNKNOWN = 0;
  PENDING = 1;
  PROCESSING = 2;
  COMPLETED = 3;
  FAILED = 4;
}

service TaskService {
  rpc CreateTask(CreateTaskRequest) returns (CreateTaskResponse);
  rpc GetTaskStatus(GetTaskStatusRequest) returns (GetTaskStatusResponse);
}

message CreateTaskRequest {
  string original_file_key = 1;
  string original_filename = 2;
}

message CreateTaskResponse {
  string task_id = 1;
}

message GetTaskStatusRequest {
  string task_id = 1;
}

message GetTaskStatusResponse {
  string task_id = 1;
  TaskStatus status = 2;
  string result_key = 3;
  string error_message = 4;
}
```



## **3.3 å…³é”®é€»è¾‘æµç¨‹ä¸Žè¾¹ç•Œå¤„ç†**



- **`CreateTaskLogic`**: æŽ¥æ”¶è¯·æ±‚ï¼Œç”Ÿæˆ`task_id`ï¼Œåœ¨Redisä¸­åˆå§‹åŒ–çŠ¶æ€ä¸º`PENDING`ï¼Œç„¶åŽç«‹å³é€šè¿‡gRPCè°ƒç”¨`processor`æœåŠ¡çš„`ExecuteTask`ã€‚å¤„ç†`processor`æœåŠ¡è¿‡è½½æˆ–æ— å“åº”çš„è¾¹ç•Œæƒ…å†µã€‚
- **`GetTaskStatusLogic`**: ä»ŽRedisä¸­æŸ¥è¯¢æŒ‡å®š`task_id`çš„çŠ¶æ€å¹¶è¿”å›žã€‚å¤„ç†ä»»åŠ¡IDä¸å­˜åœ¨çš„è¾¹ç•Œæƒ…å†µã€‚



## **3.4 `processor` æœåŠ¡çš„é…åˆè®¾è®¡**



ï¼ˆå†…å®¹ä¿æŒä¸å˜ï¼‰

------



# **4. `processor`æœåŠ¡æž¶æž„è®¾è®¡**





## **4.1 æµç¨‹æ¦‚è¿°**



`processor` æœåŠ¡æ˜¯æ‰§è¡Œæ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„åœ°æ–¹ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€é•¿è½®è¯¢çš„å·¥ä½œè¿›ç¨‹ã€‚å®ƒé€šè¿‡è°ƒç”¨å¤–éƒ¨ API å’Œå†…éƒ¨AIå¾®æœåŠ¡æ¥å®Œæˆæ‰€æœ‰AIå¤„ç†ã€‚

**å¹¶å‘æŽ§åˆ¶ç­–ç•¥**ï¼š

- ä½¿ç”¨å¸¦ç¼“å†²çš„ Channel ä½œä¸ºä¿¡å·é‡ï¼Œé™åˆ¶åŒæ—¶å¤„ç†çš„ä»»åŠ¡æ•°é‡ï¼ˆé»˜è®¤ `maxConcurrency = 1`ï¼‰ã€‚



## **4.2 è¯¦ç»†æ­¥éª¤æ‹†è§£**



é˜¶æ®µä¸€ï¼šä»»åŠ¡åˆå§‹åŒ–ä¸Žé¢„å¤„ç†

(æ­¥éª¤1-3ä¿æŒä¸å˜: æŽ¥æ”¶ä»»åŠ¡ã€è¯»å–æ–‡ä»¶ã€åˆ†ç¦»éŸ³é¢‘)

é˜¶æ®µäºŒï¼šæ ¸å¿ƒAIå¤„ç†ï¼ˆè°ƒç”¨å¤–éƒ¨APIä¸Žå†…éƒ¨å¾®æœåŠ¡ï¼‰

4. è°ƒç”¨ ASR æœåŠ¡è¿›è¡Œè¯­éŸ³è¯†åˆ«:

- **åŠ¨ä½œ**: è°ƒç”¨**å¤–éƒ¨ ASR æœåŠ¡**ç»Ÿä¸€æŽ¥å£ã€‚

1. **è°ƒç”¨ LLM æœåŠ¡è¿›è¡Œæ–‡æœ¬æ¶¦è‰²**ï¼ˆå¯é€‰ï¼‰:
	- **åŠ¨ä½œ**: è°ƒç”¨**å¤–éƒ¨ LLM æœåŠ¡**ç»Ÿä¸€æŽ¥å£ã€‚
2. **è°ƒç”¨ Translation æœåŠ¡è¿›è¡Œæ–‡æœ¬ç¿»è¯‘**:
	- **åŠ¨ä½œ**: è°ƒç”¨**å¤–éƒ¨ Translation æœåŠ¡**ç»Ÿä¸€æŽ¥å£ã€‚
3. **è°ƒç”¨ LLM æœåŠ¡è¿›è¡Œè¯‘æ–‡ä¼˜åŒ–**ï¼ˆå¯é€‰ï¼‰:
	- **åŠ¨ä½œ**: è°ƒç”¨**å¤–éƒ¨ LLM æœåŠ¡**ç»Ÿä¸€æŽ¥å£ã€‚
4. **è°ƒç”¨æœ¬åœ° Voice Cloning æœåŠ¡ç”Ÿæˆä¸­æ–‡éŸ³é¢‘**:
	- **åŠ¨ä½œ**: é€šè¿‡ gRPC å®¢æˆ·ç«¯ï¼Œè°ƒç”¨**æœ¬åœ°çš„ `tts-worker` å¾®æœåŠ¡**ã€‚
	- **è¾“å…¥**: ä¼˜åŒ–åŽçš„ä¸­æ–‡æ–‡æœ¬ + åŽŸè§†é¢‘éŸ³é¢‘ï¼ˆä½œä¸ºéŸ³è‰²å‚è€ƒï¼‰ã€‚
	- **å¤„ç†**: `tts-worker` æœåŠ¡åŠ è½½ `GTP-SoVITS` æ¨¡åž‹ï¼Œåœ¨ GPU ä¸Šæ‰§è¡Œå£°éŸ³å…‹éš†ã€‚
	- **è¾“å‡º**: ç”Ÿæˆçš„ä¸­æ–‡éŸ³é¢‘æ–‡ä»¶ï¼ˆæœ¬åœ°ä¸´æ—¶æ–‡ä»¶ï¼‰ã€‚

é˜¶æ®µä¸‰ï¼šåˆæˆä¸Žç»ˆå¤„ç†

9. åˆæˆæœ€ç»ˆè§†é¢‘:

- **åŠ¨ä½œ**: è°ƒç”¨ `ffmpeg` å°†åŽŸå§‹è§†é¢‘çš„è§†é¢‘æµä¸Žæ–°çš„ä¸­æ–‡éŸ³è½¨åˆå¹¶ã€‚

1. **ä¿å­˜å¹¶å®Œæˆä»»åŠ¡ (æˆåŠŸè·¯å¾„)**:
	- **åŠ¨ä½œ**: ä¿å­˜æœ€ç»ˆè§†é¢‘ï¼Œæ›´æ–° Redis çŠ¶æ€ä¸º `COMPLETED`ï¼Œé‡Šæ”¾ worker æ§½ä½ã€‚

é˜¶æ®µå››ä¸Žäº”ï¼šå…¨å±€å¼‚å¸¸å¤„ç†ä¸ŽGC

ï¼ˆå†…å®¹ä¿æŒä¸å˜ï¼‰



## **4.3 å¯è§†åŒ–æµç¨‹å›¾**



Code snippet

```
graph TD
    subgraph GoProcessorService [Go Processor Service - æ ‡å‡†æ¨¡å¼]
        A["å¼€å§‹: æŽ¥æ”¶ gRPC è°ƒç”¨"] --> A1["å°è¯•èŽ·å– worker æ§½ä½"];
        A1 -- èŽ·å–å¤±è´¥ --> A2["è¿”å›ž ResourceExhausted"];
        A1 -- èŽ·å–æˆåŠŸ --> B["æ›´æ–°RedisçŠ¶æ€ä¸ºPROCESSING"];
        B --> C["ä»Žæœ¬åœ°è¯»å–åŽŸå§‹è§†é¢‘"];
        C --> D["è°ƒç”¨FFmpegåˆ†ç¦»å‡ºéŸ³é¢‘"];
        D --> E["è°ƒç”¨ å¤–éƒ¨ASR æœåŠ¡"];
        E --> E1{æ–‡æœ¬æ¶¦è‰²?};
        E1 -- æ˜¯ --> E2["è°ƒç”¨ å¤–éƒ¨LLM æœåŠ¡"];
        E1 -- å¦ --> F;
        E2 --> F["è°ƒç”¨ å¤–éƒ¨Translation æœåŠ¡"];
        F --> F1{è¯‘æ–‡ä¼˜åŒ–?};
        F1 -- æ˜¯ --> F2["è°ƒç”¨ å¤–éƒ¨LLM æœåŠ¡"];
        F1 -- å¦ --> G;
        F2 --> G["**è°ƒç”¨ æœ¬åœ°TTSæœåŠ¡ (gRPC)**\n(tts-worker)"];
        G --> H["è°ƒç”¨FFmpegåˆæˆæ–°è§†é¢‘"];
        H --> I["ä¿å­˜æœ€ç»ˆè§†é¢‘åˆ°æœ¬åœ°"];
        I --> J["æ›´æ–°RedisçŠ¶æ€ä¸ºCOMPLETED"];
        J --> J1["é‡Šæ”¾ worker æ§½ä½"];
        J1 --> K[ç»“æŸ: ä»»åŠ¡æˆåŠŸ];
    end

    subgraph ErrorHandling [Error Handling]
        L["è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—"];
        M["æ›´æ–°RedisçŠ¶æ€ä¸ºFAILED"];
        M --> M1["é‡Šæ”¾ worker æ§½ä½"];
        M1 --> N[ç»“æŸ: ä»»åŠ¡å¤±è´¥];
    end

    C -- å¤±è´¥ --> L;
    D -- å¤±è´¥ --> L;
    E -- å¤±è´¥/è¶…æ—¶ --> L;
    F -- å¤±è´¥/è¶…æ—¶ --> L;
    G -- å¤±è´¥/è¶…æ—¶ --> L;
    H -- å¤±è´¥ --> L;
    I -- å¤±è´¥ --> L;
    L --> M;
```